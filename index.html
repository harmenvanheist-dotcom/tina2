<!doctype html>
<html lang="nl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Tina 2 — Audio chat</title>

    <style>
      * { box-sizing: border-box; }
      html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
      #root { height: 100%; display: flex; align-items: center; justify-content: center; background: #f5f5f5; }
      .note { position: fixed; top: 8px; left: 10px; font-size: 12px; color: #666; z-index: 10; }
      .error { padding: 16px; margin: 16px; background: #fee; color: #c00; border-radius: 4px; max-width: 400px; }
      .chatkit-wrapper { width: 380px; height: 640px; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
      @media (max-width: 420px){ .chatkit-wrapper{ width: 100vw; height: 100vh; border-radius: 0; } }
    </style>
  </head>
  <body>
    <div class="note">Tina2 • MorgenAcademy</div>
    <div id="root"></div>

    <!-- React & ReactDOM via CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel standalone voor JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- ChatKit React -->
    <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit-react.js"></script>

    <script type="text/babel">
      const { useState, useEffect } = React;
      const { ChatKit, useChatKit } = window.ChatKitReact || {};

      function App() {
        const [error, setError] = useState(null);

        // Helper: vraag client secret aan
        async function getClientSecret(existing) {
          try {
            const res = await fetch("/.netlify/functions/chatkit-session", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(existing ? { refresh: { client_secret: existing } } : {})
            });
            
            if (!res.ok) {
              throw new Error(`Session error: ${res.status}`);
            }
            
            const data = await res.json();
            return data.client_secret;
          } catch (err) {
            console.error('❌ Session error:', err);
            throw err;
          }
        }

        // Setup ChatKit
        const chatkit = useChatKit({
          api: {
            async getClientSecret(existing) {
              return getClientSecret(existing || null);
            },
          },
          audio: { input: true, output: true },
        });

        if (error) {
          return (
            <div className="error">
              <strong>Fout:</strong><br />
              {error}
            </div>
          );
        }

        return (
          <div className="chatkit-wrapper">
            <ChatKit control={chatkit.control} />
          </div>
        );
      }

      // Render app
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
