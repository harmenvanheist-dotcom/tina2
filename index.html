<!doctype html>
<html lang="nl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Tina 2 — Audio chat</title>

    <!-- Laad ChatKit runtime -->
    <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js"></script>

    <style>
      html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
      .wrap { display: grid; place-items: center; height: 100%; }
      .note { position: fixed; top: 8px; left: 10px; font-size: 12px; color: #666; }
      #chatkit-container { width: 380px; height: 640px; }
      @media (max-width: 420px){ #chatkit-container{ width: 100vw; height: 100vh; } }
    </style>
  </head>
  <body>
    <div class="note">Tina2 • MorgenAcademy</div>
    <div class="wrap">
      <!-- Container waar ChatKit zijn UI in mount -->
      <div id="chatkit-container"></div>
    </div>

    <script>
      // Wacht tot chatkit.js geladen is
      (async function boot() {
        const loader = document.querySelector('script[src*="chatkit"]');
        if (loader) {
          loader.addEventListener("error", (err) => {
            console.error("chatkit.js failed to load", err);
            document.body.insertAdjacentHTML("afterbegin", "<div style='padding:8px;color:#900'>Fout: chatkit.js kon niet geladen worden</div>");
          }, { once: true });
          loader.addEventListener("load", () => {
            console.info("chatkit.js geladen");
          }, { once: true });
        }

        const container = document.getElementById("chatkit-container");
        if (!container) {
          document.body.insertAdjacentHTML("afterbegin", "<div style='padding:8px;color:#900'>Fout: ChatKit container ontbreekt</div>");
          return;
        }

        const resolveRuntime = () => {
          const candidates = [
            window.ChatKit,
            window.chatkit,
            window.chatKit,
          ];
          for (const runtime of candidates) {
            if (runtime && typeof runtime.createControl === "function") {
              return runtime;
            }
          }
          return null;
        };

        const ensureRuntime = async () => {
          const immediate = resolveRuntime();
          if (immediate) return immediate;

          for (let i = 0; i < 50; i++) {
            await new Promise(r => setTimeout(r, 100));
            const runtime = resolveRuntime();
            if (runtime) {
              return runtime;
            }
          }
          throw new Error("chatkit runtime niet beschikbaar");
        };

        let runtime;
        try {
          runtime = await ensureRuntime();
        } catch (err) {
          const detail = err instanceof Error ? err.message : String(err);
          console.error("ChatKit runtime niet beschikbaar", detail);
          document.body.insertAdjacentHTML("afterbegin", `<div style='padding:8px;color:#900'>Fout: ChatKit runtime niet beschikbaar (${detail})</div>`);
          return;
        }

        // Helper: vraag client secret aan je Netlify Function
        async function getClientSecret(current) {
          // Start of refresh op basis van presence van current
          const res = await fetch("/.netlify/functions/chatkit-session", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(current ? { refresh: { client_secret: current } } : {})
          });
          if (!res.ok) throw new Error("Session endpoint faalde: " + res.status);
          const data = await res.json();
          return data.client_secret;
        }

        // Maak control aan met audio ondersteuning
        let control;
        try {
          control = await runtime.createControl({
            api: {
              async getClientSecret(existing) {
                return getClientSecret(existing || null);
              },
            },
            audio: { input: true, output: true },
          });
        } catch (err) {
          console.error("Kon ChatKit control niet maken", err);
          document.body.insertAdjacentHTML("afterbegin", "<div style='padding:8px;color:#900'>Fout: ChatKit control kon niet gemaakt worden</div>");
          return;
        }

        // Mount mini audio widget
        try {
          await runtime.mount(container, {
            control,
            widget: "mini-chat-audio",
          });
        } catch (err) {
          console.error("Kon ChatKit mounten", err);
          document.body.insertAdjacentHTML("afterbegin", "<div style='padding:8px;color:#900'>Fout: ChatKit mount mislukte</div>");
        }
      })();
    </script>
  </body>
</html>
