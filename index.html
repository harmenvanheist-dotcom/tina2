<!doctype html>
<html lang="nl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Tina 2 — Audio chat</title>

    <!-- Laad ChatKit runtime -->
    <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js"></script>

    <style>
      html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
      .wrap { display: grid; place-items: center; height: 100%; }
      .note { position: fixed; top: 8px; left: 10px; font-size: 12px; color: #666; }
      openai-chatkit { width: 380px; height: 640px; }
      @media (max-width: 420px){ openai-chatkit{ width: 100vw; height: 100vh; } }
    </style>
  </head>
  <body>
    <div class="note">Tina2 • MorgenAcademy</div>
    <div class="wrap">
      <!-- Web component dat ChatKit rendert -->
      <openai-chatkit id="my-chat"></openai-chatkit>
    </div>

    <script>
      // Wacht tot chatkit.js geladen is
      (async function boot() {
        const loader = document.querySelector('script[src*="chatkit"]');
        if (loader) {
          loader.addEventListener("error", (err) => {
            console.error("chatkit.js failed to load", err);
            document.body.insertAdjacentHTML("afterbegin", "<div style='padding:8px;color:#900'>Fout: chatkit.js kon niet geladen worden</div>");
          }, { once: true });
          loader.addEventListener("load", () => {
            console.info("chatkit.js geladen");
          }, { once: true });
        }

        const el = document.getElementById("my-chat");
        if (!el) {
          document.body.insertAdjacentHTML("afterbegin", "<div style='padding:8px;color:#900'>Fout: ChatKit element ontbreekt</div>");
          return;
        }

        const isComponentReady = () =>
          !!customElements.get("openai-chatkit") &&
          typeof el.setOptions === "function";

        async function waitForComponent() {
          if (isComponentReady()) return;

          await new Promise((resolve, reject) => {
            let settled = false;

            const clear = () => {
              settled = true;
              window.removeEventListener("chatkit-script-loaded", onLoaded);
              window.removeEventListener("chatkit-script-error", onError);
              if (loader) {
                loader.removeEventListener("error", onError);
              }
              if (timeoutId) {
                clearTimeout(timeoutId);
              }
            };

            const onLoaded = () => {
              if (settled) return;
              if (isComponentReady()) {
                clear();
                resolve(null);
              }
            };

            const onError = (event) => {
              if (settled) return;
              clear();
              reject(event instanceof Error ? event : new Error("chatkit-script-error"));
            };

            window.addEventListener("chatkit-script-loaded", onLoaded);
            window.addEventListener("chatkit-script-error", onError);
            if (loader) {
              loader.addEventListener("error", onError, { once: true });
            }

            const timeoutId = setTimeout(() => {
              if (settled) return;
              clear();
              reject(new Error("chatkit component timed out (6s)"));
            }, 6000);
          });

          if (!isComponentReady()) {
            throw new Error("chatkit component not available after wait");
          }
        }

        try {
          await waitForComponent();
        } catch (err) {
          const detail = err instanceof Error ? err.message : String(err);
          console.error("ChatKit component werd niet beschikbaar", detail);
          document.body.insertAdjacentHTML("afterbegin", `<div style='padding:8px;color:#900'>Fout: ChatKit component niet beschikbaar (${detail})</div>`);
          return;
        }


        // Helper: vraag client secret aan je Netlify Function
        async function getClientSecret(current) {
          // Start of refresh op basis van presence van current
          const res = await fetch("/.netlify/functions/chatkit-session", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(current ? { refresh: { client_secret: current } } : {})
          });
          if (!res.ok) throw new Error("Session endpoint faalde: " + res.status);
          const data = await res.json();
          return data.client_secret;
        }

        // Configureer ChatKit (hosted workflow)
        try {
          await el.setOptions({
            api: {
              // eerste token
              async getClientSecret(existing) {
                return getClientSecret(existing || null);
              },
            },
            // Direct audio UI
            input: { type: "voice" },
            output: { type: "voice" },
            widget: { default: "mini-chat-audio" }
          });
        } catch (err) {
          console.error("Kon ChatKit configureren", err);
          document.body.insertAdjacentHTML("afterbegin", "<div style='padding:8px;color:#900'>Fout: ChatKit configuratie mislukte</div>");
        }
      })();
    </script>
  </body>
</html>
