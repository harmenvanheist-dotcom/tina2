<!doctype html>
<html lang="nl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Tina 2 — Audio chat</title>

    <!-- Laad ChatKit runtime -->
    <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js" defer></script>

    <style>
      html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
      .wrap { display: grid; place-items: center; height: 100%; }
      .note { position: fixed; top: 8px; left: 10px; font-size: 12px; color: #666; }
      openai-chatkit { width: 380px; height: 640px; }
      @media (max-width: 420px){ openai-chatkit{ width: 100vw; height: 100vh; } }
    </style>
  </head>
  <body>
    <div class="note">Tina2 • MorgenAcademy</div>
    <div class="wrap">
      <!-- Web component dat ChatKit rendert -->
      <openai-chatkit id="my-chat"></openai-chatkit>
    </div>

    <script>
      // Wacht tot chatkit.js geladen is
      (async function boot() {
        // kleine backoff tot script klaar is
        const getRuntime = () =>
          window.openaiChatKit || window.chatkit || window.ChatKit;

        for (let i = 0; i < 40 && !getRuntime(); i++) {
          await new Promise(r => setTimeout(r, 100));
        }

        const chatkitRuntime = getRuntime();
        const el = document.getElementById("my-chat");
        if (!chatkitRuntime || !el) {
          document.body.insertAdjacentHTML("afterbegin", "<div style='padding:8px;color:#900'>Fout: ChatKit niet geladen</div>");
          return;
        }

        try {
          await customElements.whenDefined("openai-chatkit");
        } catch (err) {
          console.error("Kon custom element niet initialiseren", err);
        }

        if (typeof el.setOptions !== "function") {
          document.body.insertAdjacentHTML("afterbegin", "<div style='padding:8px;color:#900'>Fout: ChatKit component niet beschikbaar</div>");
          return;
        }

        // Helper: vraag client secret aan je Netlify Function
        async function getClientSecret(current) {
          // Start of refresh op basis van presence van current
          const res = await fetch("/.netlify/functions/chatkit-session", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(current ? { refresh: { client_secret: current } } : {})
          });
          if (!res.ok) throw new Error("Session endpoint faalde: " + res.status);
          const data = await res.json();
          return data.client_secret;
        }

        // Configureer ChatKit (hosted workflow)
        try {
          await el.setOptions({
            api: {
              // eerste token
              async getClientSecret(existing) {
                return getClientSecret(existing || null);
              },
            },
            // Direct audio UI
            input: { type: "voice" },
            output: { type: "voice" },
            widget: { default: "mini-chat-audio" }
          });
        } catch (err) {
          console.error("Kon ChatKit configureren", err);
          document.body.insertAdjacentHTML("afterbegin", "<div style='padding:8px;color:#900'>Fout: ChatKit configuratie mislukte</div>");
        }
      })();
    </script>
  </body>
</html>
