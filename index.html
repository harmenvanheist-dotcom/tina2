<!doctype html>
<html lang="nl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Tina 2 ‚Äî Audio chat</title>

    <style>
      html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
      .wrap { display: grid; place-items: center; height: 100%; background: #f5f5f5; }
      .note { position: fixed; top: 8px; left: 10px; font-size: 12px; color: #666; z-index: 10; }
      .error { padding: 16px; margin: 16px; background: #fee; color: #c00; border-radius: 4px; max-width: 400px; }
      .loading { padding: 16px; color: #666; }
      #chatkit-container { width: 380px; height: 640px; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); background: white; }
      @media (max-width: 420px){ #chatkit-container{ width: 100vw; height: 100vh; border-radius: 0; } }
    </style>
  </head>
  <body>
    <div class="note">Tina2 ‚Ä¢ MorgenAcademy</div>
    <div class="wrap">
      <div id="chatkit-container">
        <div class="loading">ChatKit wordt geladen...</div>
      </div>
    </div>

    <!-- Laad ChatKit ZONDER async, dan wachten we tot het klaar is -->
    <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js"></script>
    
    <script>
      // Deze code draait PAS nadat chatkit.js geladen is
      (async function boot() {
        const container = document.getElementById("chatkit-container");
        
        function showError(msg) {
          container.innerHTML = `<div class="error"><strong>Fout:</strong><br>${msg}</div>`;
          console.error('ChatKit Error:', msg);
        }

        try {
          console.log('üîç Zoeken naar ChatKit runtime...');
          console.log('window.ChatKit:', typeof window.ChatKit);
          console.log('window.chatkit:', typeof window.chatkit);
          console.log('window.OpenAIChatKit:', typeof window.OpenAIChatKit);
          
          // Probeer alle mogelijke exports
          const ChatKit = window.ChatKit || window.chatkit || window.OpenAIChatKit;
          
          if (!ChatKit) {
            // Laat ALLE beschikbare objecten zien
            const allKeys = Object.keys(window).filter(k => k.toLowerCase().includes('chat') || k.toLowerCase().includes('openai'));
            throw new Error(`ChatKit niet gevonden. Beschikbare objecten: ${allKeys.join(', ') || 'geen'}`);
          }

          console.log('‚úÖ ChatKit gevonden!');
          console.log('üì¶ Beschikbare methodes:', Object.keys(ChatKit));

          // Helper functie
          async function getClientSecret(current) {
            console.log('üîë Vraag client secret aan...', current ? '(refresh)' : '(nieuw)');
            const res = await fetch("/.netlify/functions/chatkit-session", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(current ? { refresh: { client_secret: current } } : {})
            });
            
            if (!res.ok) {
              const error = await res.text();
              throw new Error(`Session endpoint faalde (${res.status}): ${error}`);
            }
            
            const data = await res.json();
            console.log('‚úÖ Client secret ontvangen');
            return data.client_secret;
          }

          // Maak control aan
          console.log('üéõÔ∏è Maak ChatKit control...');
          const control = await ChatKit.createControl({
            api: {
              async getClientSecret(existing) {
                return getClientSecret(existing || null);
              },
            },
            audio: { input: true, output: true },
          });

          console.log('‚úÖ Control gemaakt');

          // Mount widget
          console.log('üöÄ Mount ChatKit widget...');
          await ChatKit.mount(container, {
            control,
            widget: "mini-chat-audio",
          });
          
          console.log('‚úÖ ChatKit succesvol geladen!');
          
        } catch (err) {
          console.error('‚ùå ChatKit fout:', err);
          showError(err.message);
        }
      })();
    </script>
  </body>
</html>
